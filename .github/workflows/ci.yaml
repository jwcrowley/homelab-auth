
name: Platform CI

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          curl -sSL https://get.helm.sh/helm-v3.14.0-linux-amd64.tar.gz | tar -xz
          sudo mv linux-amd64/helm /usr/local/bin/
          curl -sSL https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz | tar -xz
          sudo mv kubeval /usr/local/bin/
          curl -sSL https://github.com/open-policy-agent/conftest/releases/latest/download/conftest_linux_amd64.tar.gz | tar -xz
          sudo mv conftest /usr/local/bin/
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh
          sudo mv bin/trivy /usr/local/bin/
          curl -sSL https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64 -o cosign
          chmod +x cosign
          sudo mv cosign /usr/local/bin/

      - name: Helm template validation
        run: helm template ./

      - name: kubeval
        run: kubeval **/*.yaml || true

      - name: conftest policy checks
        run: conftest test .

      - name: Generate SBOM
        run: trivy fs --format cyclonedx --output sbom.json .

      - name: Trivy vulnerability scan
        run: trivy fs .
